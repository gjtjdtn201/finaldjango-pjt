{% extends 'base.html' %}
{% load bootstrap4 %}

{% block content %}
<div class="row col-lg-10 offset-lg-1">
  <div class="d-flex">
  <h2 class='text-info mb-0'>{{ movie.title }}</h2>
    {% if request.user.is_superuser %}
    <div class="d-flex ml-auto">
      <a href="{% url 'movies:movie_update' movie.pk %}">
          <button type="button" class="btn btn-secondary mr-2">수정</button>
      </a>
      <form action="{% url 'movies:movie_delete' movie.pk %}" method="POST">
          {% csrf_token %}
          <input class="btn btn-secondary" type="submit" value="삭제">
      </form>
    </div>
      {% endif %}
  </div>
  <hr>
  <ul class="list-group">
    <li class="list-group-item">
      <div class="card mb-3 border border-white">
        <div class="row no-gutters">
          <div class="col-md-4">
            <img src="{{ movie.poster_path }}" class="card-img" alt="movie-img">
          </div>
          <div class="col-md-8 pl-3">
            <div class="card-body">
              <h3 class="card-title">{{ movie.title }}</h3>
              <h4 class="card-text"><small class="text-muted">제작년도 : {{ movie.release_date }}</small></h4>
              <h4 class="card-text"><small class="text-muted">평점 : {{ movie.voteavg }}점</small></h4>
              {% if not movie.mdirector.name == '없음' %}
                <h4 class="card-text"><small class="text-muted">감독 : {{ movie.mdirector }}</small></h4>
              {% endif %}
              <h4 class="card-text">
                <small class="text-muted">주연 : 
                  {% for actor in movie.actors.all %}
                    {{ actor.name }},
                  {% endfor %}
                </small>
              </h4>
              <div class="mb-3">
                {% for gen in movie.genres.all %}
                  <button class="btn btn-secondary my-1">{{ gen.name }}</button>
                {% endfor %}
              </div>
              {% if request.user in movie.like_users.all %}
                <i class=" fas fa-heart fa-3x like-btn" data-pk="{{ movie.pk }}" style="color:red" ></i>
              {% else %}
                <i class=" far fa-heart fa-3x like-btn" data-pk="{{ movie.pk }}" style="color:gray" ></i>
              {% endif %}
              <span class="cnt-{{ movie.pk }}">{{ movie.like_users.all|length }}</span> 명이 이 영화를 좋아합니다.
            </div>
          </div>
        </div>
      </div>
    </li>
    <li class="list-group-item">
      <h5 class="text-dark">시놉시스</h5>
      {{ movie.overview }}
    </li>
    <li class="list-group-item">
      <h3 class="text-primary m-3">주연 배우</h3>
      <div class="card-group mx-4">
        {% for actor in movie.actors.all %}
        <div class="card">
          <img src="{{ actor.profile_path }}" class="card-img-top" alt="...">
          <div class="card-body">
            <h5 class="card-title text-center">{{ actor.name }}</h5>
          </div>
        </div>
        {% endfor %}
      </div> 
    </li>
  </ul>
</div>
<p class="mb-5"></p>

<script>
  const likeBtns = document.querySelectorAll('.like-btn')
  likeBtns.forEach(function(btn){
    btn.addEventListener('click', function(event){
      axios.get(`/movies/${btn.dataset.pk}/like/`)
      .then(function(res){
        console.log(res.data)
        if (res.data.liked){
          btn.style.color = 'crimson'
        } else {
            btn.style.color  = 'black'
          }
          const cntSpan = document.querySelector(`.cnt-${btn.dataset.pk}`)
          cntSpan.innerText = res.data.count
      })
      .catch(function(err){
        console.log(err)
      })

    })
  })
</script>
{% endblock %}
